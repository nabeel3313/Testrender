{% extends "base.html" %}

{% block title %}Session Room - DirectProf{% endblock %}

{% block content %}
<div class="container-fluid vh-100 d-flex flex-column" style="background-color: #1a1a1a;">
    <!-- Session Header -->
    <div class="row bg-dark text-white py-3">
        <div class="col-12">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">{{ session.title }}</h4>
                        <small class="text-muted">
                            with {{ session.trainer.first_name }} {{ session.trainer.last_name }}
                            {% if current_user.user_type == 'learner' %}
                            (Trainer)
                            {% else %}
                            and {{ session.learner.first_name }} {{ session.learner.last_name }} (Learner)
                            {% endif %}
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <div id="session-timer" class="badge bg-secondary fs-6">00:00:00</div>
                        <button id="toggle-chat" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-comments"></i> Chat
                        </button>
                        <button class="btn btn-outline-light btn-sm">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row flex-grow-1">
        <!-- Video Area -->
        <div class="col-md-9 d-flex flex-column p-0">
            <!-- Main Video -->
            <div class="flex-grow-1 position-relative">
                <div id="main-video" class="h-100 w-100 bg-dark">
                    <div class="h-100 d-flex flex-column justify-content-center align-items-center text-white">
                        <i class="fas fa-user fa-5x mb-3 text-muted"></i>
                        <h4>Waiting for participant to join...</h4>
                        <div class="spinner-border text-primary mt-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Video Controls -->
                <div class="position-absolute bottom-0 start-50 translate-middle-x mb-3">
                    <div class="btn-group" role="group">
                        <button id="toggle-video" class="btn btn-light">
                            <i class="fas fa-video"></i>
                        </button>
                        <button id="toggle-audio" class="btn btn-light">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button id="screen-share" class="btn btn-light">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button id="end-call" class="btn btn-danger">
                            <i class="fas fa-phone-slash"></i> End Call
                        </button>
                    </div>
                </div>
            </div>

            <!-- Participant Thumbnails -->
            <div class="bg-secondary p-2" style="height: 120px;">
                <div class="d-flex gap-2 h-100">
                    <!-- Local Video Thumbnail -->
                    <div class="participant-thumbnail bg-dark rounded position-relative" style="width: 160px;">
                        <div class="h-100 d-flex justify-content-center align-items-center text-white">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="position-absolute bottom-0 start-0 p-1">
                            <small class="text-white">You</small>
                        </div>
                    </div>
                    
                    <!-- Remote Video Thumbnail -->
                    <div class="participant-thumbnail bg-dark rounded position-relative" style="width: 160px;">
                        <div class="h-100 d-flex justify-content-center align-items-center text-white">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="position-absolute bottom-0 start-0 p-1">
                            <small class="text-white">
                                {% if current_user.user_type == 'learner' %}
                                {{ session.trainer.first_name }}
                                {% else %}
                                {{ session.learner.first_name }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Sidebar -->
        <div id="chat-sidebar" class="col-md-3 bg-light d-flex flex-column" style="display: none !important;">
            <div class="flex-grow-1 d-flex flex-column">
                <!-- Chat Header -->
                <div class="p-3 border-bottom">
                    <h6 class="mb-0">Session Chat</h6>
                </div>
                
                <!-- Messages -->
                <div id="chat-messages" class="flex-grow-1 p-3" style="overflow-y: auto; max-height: 400px;">
                    <div class="text-center text-muted small">
                        <p>Chat started</p>
                    </div>
                    <!-- Messages will be appended here -->
                </div>
                
                <!-- Message Input -->
                <div class="p-3 border-top">
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
                        <button id="send-message" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Session Tools -->
            <div class="p-3 border-top">
                <h6 class="mb-2">Session Tools</h6>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-file-alt me-2"></i>Shared Notes
                    </button>
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-stopwatch me-2"></i>Timer
                    </button>
                    <button class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-2"></i>Record Session
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chat toggle functionality
    document.getElementById('toggle-chat').addEventListener('click', function() {
        const chatSidebar = document.getElementById('chat-sidebar');
        if (chatSidebar.style.display === 'none') {
            chatSidebar.style.display = 'block';
            this.innerHTML = '<i class="fas fa-comments"></i> Hide Chat';
        } else {
            chatSidebar.style.display = 'none';
            this.innerHTML = '<i class="fas fa-comments"></i> Chat';
        }
    });

    // Session timer
    let startTime = Date.now();
    function updateTimer() {
        const elapsed = Date.now() - startTime;
        const hours = Math.floor(elapsed / 3600000);
        const minutes = Math.floor((elapsed % 3600000) / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        
        document.getElementById('session-timer').textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    setInterval(updateTimer, 1000);

    // Chat functionality
    document.getElementById('send-message').addEventListener('click', sendMessage);
    document.getElementById('chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (message) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'mb-2';
            messageElement.innerHTML = `
                <div class="d-flex justify-content-end">
                    <div class="bg-primary text-white rounded p-2" style="max-width: 80%;">
                        <small class="d-block">You</small>
                        ${message}
                    </div>
                </div>
            `;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.value = '';
        }
    }

    // End call button
    document.getElementById('end-call').addEventListener('click', function() {
        if (confirm('Are you sure you want to end this session?')) {
            window.location.href = "{{ url_for('dashboard') }}";
        }
    });
</script>
{% endblock %}